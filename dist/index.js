class _ extends Error{response;request;options;constructor(t,s,o){const n=t.status||t.status===0?t.status:"",r=t.statusText||"",a=`${n} ${r}`.trim(),i=a?`status code ${a}`:"an unknown error";super(`Request failed with ${i}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=t,this.request=s,this.options=o}}class S extends Error{request;constructor(t){super(`Request timed out: ${t.method} ${t.url}`),this.name="TimeoutError",this.request=t}}const R=(()=>{let e=!1,t=!1;const s=typeof globalThis.ReadableStream=="function",o=typeof globalThis.Request=="function";if(s&&o)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(n){if(n instanceof Error&&n.message==="unsupported BodyInit type")return!1;throw n}return e&&!t})(),F=typeof globalThis.AbortController=="function",M=typeof globalThis.AbortSignal=="function"&&typeof globalThis.AbortSignal.any=="function",H=typeof globalThis.ReadableStream=="function",D=typeof globalThis.FormData=="function",q=["get","post","put","patch","head","delete"],J={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},m=2147483647,z=new TextEncoder().encode("------WebKitFormBoundaryaxpyiPgbbPti10Rw").length,E=Symbol("stop"),V={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,onUploadProgress:!0,fetch:!0},K={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},Y=e=>{if(!e)return 0;if(e instanceof FormData){let t=0;for(const[s,o]of e)t+=z,t+=new TextEncoder().encode(`Content-Disposition: form-data; name="${s}"`).length,t+=typeof o=="string"?new TextEncoder().encode(o).length:o.size;return t}if(e instanceof Blob)return e.size;if(e instanceof ArrayBuffer)return e.byteLength;if(typeof e=="string")return new TextEncoder().encode(e).length;if(e instanceof URLSearchParams)return new TextEncoder().encode(e.toString()).length;if("byteLength"in e)return e.byteLength;if(typeof e=="object"&&e!==null)try{const t=JSON.stringify(e);return new TextEncoder().encode(t).length}catch{return 0}return 0},W=(e,t)=>{const s=Number(e.headers.get("content-length"))||0;let o=0;return e.status===204?(t&&t({percent:1,totalBytes:s,transferredBytes:o},new Uint8Array),new Response(null,{status:e.status,statusText:e.statusText,headers:e.headers})):new Response(new ReadableStream({async start(n){const r=e.body.getReader();t&&t({percent:0,transferredBytes:0,totalBytes:s},new Uint8Array);async function a(){const{done:i,value:c}=await r.read();if(i){n.close();return}if(t){o+=c.byteLength;const l=s===0?0:o/s;t({percent:l,transferredBytes:o,totalBytes:s},c)}n.enqueue(c),await a()}await a()}}),{status:e.status,statusText:e.statusText,headers:e.headers})},X=(e,t)=>{const s=Y(e.body);let o=0;return new Request(e,{duplex:"half",body:new ReadableStream({async start(n){const r=e.body instanceof ReadableStream?e.body.getReader():new Response("").body.getReader();async function a(){const{done:i,value:c}=await r.read();if(i){t&&t({percent:1,transferredBytes:o,totalBytes:Math.max(s,o)},new Uint8Array),n.close();return}o+=c.byteLength;let l=s===0?0:o/s;(s<o||l===1)&&(l=.99),t&&t({percent:Number(l.toFixed(2)),transferredBytes:o,totalBytes:s},c),n.enqueue(c),await a()}await a()}})})},p=e=>e!==null&&typeof e=="object",f=(...e)=>{for(const t of e)if((!p(t)||Array.isArray(t))&&t!==void 0)throw new TypeError("The `options` argument must be an object");return b({},...e)},I=(e={},t={})=>{const s=new globalThis.Headers(e),o=t instanceof globalThis.Headers,n=new globalThis.Headers(t);for(const[r,a]of n.entries())o&&a==="undefined"||a===void 0?s.delete(r):s.set(r,a);return s};function d(e,t,s){return Object.hasOwn(t,s)&&t[s]===void 0?[]:b(e[s]??[],t[s]??[])}const x=(e={},t={})=>({beforeRequest:d(e,t,"beforeRequest"),beforeRetry:d(e,t,"beforeRetry"),afterResponse:d(e,t,"afterResponse"),beforeError:d(e,t,"beforeError")}),b=(...e)=>{let t={},s={},o={};for(const n of e)if(Array.isArray(n))Array.isArray(t)||(t=[]),t=[...t,...n];else if(p(n)){for(let[r,a]of Object.entries(n))p(a)&&r in t&&(a=b(t[r],a)),t={...t,[r]:a};p(n.hooks)&&(o=x(o,n.hooks),t.hooks=o),p(n.headers)&&(s=I(s,n.headers),t.headers=s)}return t},G=e=>q.includes(e)?e.toUpperCase():e,Q=["get","put","head","delete","options","trace"],Z=[408,413,429,500,502,503,504],tt=[413,429,503],T={limit:2,methods:Q,statusCodes:Z,afterStatusCodes:tt,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},et=(e={})=>{if(typeof e=="number")return{...T,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...T,...e}};async function st(e,t,s,o){return new Promise((n,r)=>{const a=setTimeout(()=>{s&&s.abort(),r(new S(e))},o.timeout);o.fetch(e,t).then(n).catch(r).then(()=>{clearTimeout(a)})})}async function ot(e,{signal:t}){return new Promise((s,o)=>{t&&(t.throwIfAborted(),t.addEventListener("abort",n,{once:!0}));function n(){clearTimeout(r),o(t.reason)}const r=setTimeout(()=>{t?.removeEventListener("abort",n),s()},e)})}const nt=(e,t)=>{const s={};for(const o in t)!(o in K)&&!(o in V)&&!(o in e)&&(s[o]=t[o]);return s};class y{static create(t,s){const o=new y(t,s),n=async()=>{if(typeof o._options.timeout=="number"&&o._options.timeout>m)throw new RangeError(`The \`timeout\` option cannot be greater than ${m}`);await Promise.resolve();let i=await o._fetch();for(const c of o._options.hooks.afterResponse){const l=await c(o.request,o._options,o._decorateResponse(i.clone()));l instanceof globalThis.Response&&(i=l)}if(o._decorateResponse(i),!i.ok&&o._options.throwHttpErrors){let c=new _(i,o.request,o._options);for(const l of o._options.hooks.beforeError)c=await l(c);throw c}if(o._options.onDownloadProgress){if(typeof o._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!H)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return W(i.clone(),o._options.onDownloadProgress)}return i},a=(o._options.retry.methods.includes(o.request.method.toLowerCase())?o._retry(n):n()).finally(async()=>{o.request.bodyUsed||await o.request.body?.cancel()});for(const[i,c]of Object.entries(J))a[i]=async()=>{o.request.headers.set("accept",o.request.headers.get("accept")||c);const l=await a;if(i==="json"){if(l.status===204||(await l.clone().arrayBuffer()).byteLength===0)return"";if(s.parseJson)return s.parseJson(await l.text())}return l[i]()};return a}request;abortController;_retryCount=0;_input;_options;constructor(t,s={}){if(this._input=t,this._options={...s,headers:I(this._input.headers,s.headers),hooks:x({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:G(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:et(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(F&&M){const o=this._options.signal??this._input.signal;this.abortController=new globalThis.AbortController,this._options.signal=o?AbortSignal.any([o,this.abortController.signal]):this.abortController.signal}if(R&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const n="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),r=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,n);(D&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(r,{...this.request}),this._options)}if(this._options.onUploadProgress){if(typeof this._options.onUploadProgress!="function")throw new TypeError("The `onUploadProgress` option must be a function");if(!R)throw new Error("Request streams are not supported in your environment. The `duplex` option for `Request` is not available.");this.request.body&&(this.request=X(this.request,this._options.onUploadProgress))}}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof S)throw t;if(t instanceof _){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;const o=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(o&&this._options.retry.afterStatusCodes.includes(t.response.status)){let n=Number(o)*1e3;Number.isNaN(n)?n=Date.parse(o)-Date.now():n>=Date.parse("2024-01-01")&&(n-=Date.now());const r=this._options.retry.maxRetryAfter??n;return n<r?n:r}if(t.response.status===413)throw t}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(s){const o=Math.min(this._calculateRetryDelay(s),m);if(this._retryCount<1)throw s;await ot(o,{signal:this._options.signal});for(const n of this._options.hooks.beforeRetry)if(await n({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===E)return;return this._retry(t)}}async _fetch(){for(const o of this._options.hooks.beforeRequest){const n=await o(this.request,this._options);if(n instanceof Request){this.request=n;break}if(n instanceof Response)return n}const t=nt(this.request,this._options),s=this.request;return this.request=s.clone(),this._options.timeout===!1?this._options.fetch(s,t):st(s,t,this.abortController,this._options)}}/*! MIT License © Sindre Sorhus */const g=e=>{const t=(s,o)=>y.create(s,f(e,o));for(const s of q)t[s]=(o,n)=>y.create(o,f(e,n,{method:s}));return t.create=s=>g(f(s)),t.extend=s=>(typeof s=="function"&&(s=s(e??{})),g(f(e,s))),t.stop=E,t},v=g(),rt="https://cloudflare-worker-token-service.audio-pwa.workers.dev/token",at="842170761773-ltlj9t8cap9q1ad7s1h6tb5084ouelod.apps.googleusercontent.com",it="https://oauth2.googleapis.com/token",P="videogata",A="playlists.json",C="plugins.json",h="https://www.googleapis.com",U="application/vnd.google-apps.folder",k="application/json; charset=UTF-8",j=e=>{application.postUiMessage(e)},u=v.create({hooks:{beforeRequest:[e=>{const t=localStorage.getItem("access_token");return t&&e.headers&&e.headers.set("Authorization","Bearer "+t),e}],afterResponse:[async(e,t,s)=>{if(s.status===401){const o=await ct();if(o)return e.headers.set("Authorization","Bearer "+o),u(e,t)}return s}]}}),N=(e,t)=>{localStorage.setItem("access_token",e),t&&localStorage.setItem("refresh_token",t)},ct=async()=>{const e=localStorage.getItem("refresh_token");if(!e)return;const t=localStorage.getItem("clientId"),s=localStorage.getItem("clientSecret");let o=rt;const n=new URLSearchParams;n.append("client_id",t||at),n.append("refresh_token",e),n.append("grant_type","refresh_token"),t&&s&&(n.append("client_secret",s),o=it);const r=await v.post(o,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}).json();if(r.access_token)return N(r.access_token,r.refresh_token),r.access_token},lt=async()=>{const t=document.location.host.split(".");t.shift();const s=t.join("."),o=`${document.location.protocol}//${s}`,n=await application.getPluginId(),r=localStorage.getItem("clientId")??"",a=localStorage.getItem("clientSecret")??"";j({type:"info",origin:o,pluginId:n,clientId:r,clientSecret:a})};application.onUiMessage=async e=>{switch(e.type){case"check-login":const t=localStorage.getItem("access_token");t&&j({type:"login",accessToken:t}),await lt();break;case"login":N(e.accessToken,e.refreshToken);break;case"logout":localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token");break;case"save-playlists":await ht(),application.createNotification({message:"Playlists Saved!"});break;case"load-playlists":await pt(),application.createNotification({message:"Playlists Loaded!"});break;case"save-plugins":await ft(),application.createNotification({message:"Plugins Saved!"});break;case"install-plugins":dt();break;case"set-keys":localStorage.setItem("clientId",e.clientId),localStorage.setItem("clientSecret",e.clientSecret),application.createNotification({message:"Api keys Saved!"});break}};const w=async()=>{const e=`mimeType = '${U}' and title = '${P}'`,t=await u.get(`${h}/drive/v2/files?q=${encodeURIComponent(e)}`).json();return t.items.length>0?t.items[0].id:""},L=async e=>{const t=await $(e);return t?await u.get(`${h}/drive/v2/files/${t}?alt=media`).json():void 0},$=async e=>{const t=await w();if(!t)return;const s=`'${t}' in parents and title = '${e}'`,o=await u.get(`${h}/drive/v2/files?q=${encodeURIComponent(s)}`).json();return o.items.length>0?o.items[0].id:""},ut=async()=>{await u.post(h+"/drive/v2/files",{json:{title:P,mimeType:U}})},O=async(e,t)=>{let s=await w();s||(await ut(),s=await w());const o=await $(e);if(o){const r=(await u.put(h+`/upload/drive/v2/files/${o}?uploadType=resumable`,{json:{mimeType:k}})).headers.get("location");if(!r)throw new Error("Upload location header not found");await u.put(r,{body:JSON.stringify(t)})}else{const r=(await u.post(h+"/upload/drive/v2/files?uploadType=resumable",{json:{title:e,parents:[{id:s}],mimeType:k}})).headers.get("location");if(!r)throw new Error("Upload location header not found");await u.post(r,{body:JSON.stringify(t)})}},ht=async()=>{const e=await application.getPlaylists();await O(A,e)},pt=async()=>{const e=await L(A);e&&await application.addPlaylists(e)},ft=async()=>{const e=await application.getPlugins();await O(C,e)},dt=async()=>{const e=await L(C);e&&await application.installPlugins(e)},B=e=>{localStorage.setItem("kb-color-mode",e)};application.onChangeTheme=async e=>{B(e)};const yt=async()=>{const e=await application.getTheme();B(e)};yt();
